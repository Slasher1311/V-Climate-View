<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>V-ClimateView</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>
  <!-- ===== HEADER ===== -->
  <header class="topbar">
    <div class="top-left"><div class="logo">V-ClimateView</div></div>
    <nav class="top-nav">
      <div class="nav-left">
        <span class="menu-icon" onclick="toggleMenu()">☰</span>
      </div>
      <div class="filter-menu-horizontal">
        <button onclick="showSection('weather')">Tổng quan</button>
        <button onclick="showSection('hourly')">Dự báo theo giờ</button>
        <button onclick="showSection('forecast')">Dự báo ngày</button>
        <button onclick="showSection('climate')">Khí hậu</button>
        <button onclick="showSection('trends')">Xu hướng</button>
        <button onclick="showSection('map')">Bản đồ</button>
      </div>
    </nav>
    <div class="top-right">
      <div class="search">
        <input id="searchInput" placeholder="Tìm địa điểm..." onkeyup="handleSearch()"/>
        <button id="searchBtn" onclick="performSearch()"><i class="fas fa-search"></i></button>
        <div id="searchResults" class="search-results" style="display:none"></div>
      </div>
    </div>
  </header>

  <!-- ===== FILTER FORM ===== -->
  <section class="card global-filter">
    <form id="globalFilterForm" method="get">
      <div>
        <label for="province">Tỉnh/Thành:</label>
        <input type="text" name="province" id="province" value="{{ province or '' }}">
      </div>
      <div>
        <label for="station">Tên trạm:</label>
        <input type="text" name="station_name" id="station" value="{{ station_name or '' }}">
      </div>
      <div>
        <label for="range">Khoảng thời gian:</label>
        <select name="range" id="range">
          <option value="30" {% if selected_range == 30 %}selected{% endif %}>30 ngày</option>
          <option value="90" {% if selected_range == 90 %}selected{% endif %}>90 ngày</option>
          <option value="365" {% if selected_range == 365 %}selected{% endif %}>12 tháng</option>
        </select>
      </div>
      <button type="submit">Áp dụng</button>
    </form>
  </section>

  <!-- ===== WEATHER SECTION ===== -->
  <main class="container">

    <section class="card nowcast-card-modern">
      <div class="weather-main">
        <div class="left">
          <div class="city">{{ latest_weather.city or "Hà Nội" }}</div>
          <div class="temp">{{ latest_weather.temp }}<span class="deg">°C</span></div>
          <div class="desc">{{ latest_weather.condition }} • Cảm thấy như {{ latest_weather.feels_like }}°C</div>
        </div>
        <div class="icon"><i class="fas fa-cloud" style="font-size:48px;color:#fff;"></i></div>
      </div>
      <div class="weather-details">
        <div>Độ ẩm: <strong>{{ latest_weather.humidity or "N/A" }}%</strong></div>
        <div>Gió: <strong>{{ latest_weather.wind or "N/A" }} km/h</strong></div>
        <div>Tầm nhìn: <strong>{{ (latest_weather.visibility/1000)|round(1) if latest_weather.visibility else "N/A" }} km</strong></div>
        <div>Áp suất: <strong>{{ (latest_weather.pressure/1000)|round(1) if latest_weather.pressure else "N/A" }} hPa</strong></div>
        <div>Điểm sương: <strong>{{ (latest_weather.humidity*0.01*latest_weather.temp)|round(1) if latest_weather.humidity and latest_weather.temp else "N/A" }}°C</strong></div>
      </div>
    </section>

    <!-- Thêm các section dự báo, xu hướng, khí hậu, bản đồ tương tự -->

    <section class="card map-card">
      <h4>Bản đồ thời tiết</h4>
      <div id="map" style="height:320px;border-radius:8px"></div>
    </section>
  </main>

  <!-- ===== JS ===== -->
  <script>
    async function handleSearch() {
      const query = document.getElementById("searchInput").value.trim();
      const resultsBox = document.getElementById("searchResults");
      if (query.length < 2) { resultsBox.style.display = "none"; return; }
      try {
        const res = await fetch(`/search_province?q=${encodeURIComponent(query)}`);
        const results = await res.json();
        resultsBox.innerHTML = results.map(
          p => `<div class="search-item" onclick="selectProvince('${p}')">${p}</div>`
        ).join("");
        resultsBox.style.display = results.length ? "block" : "none";
      } catch(e){ console.error(e); resultsBox.style.display = "none";}
    }
    function selectProvince(name){ location.href = `/?province=${encodeURIComponent(name)}`; }
    function performSearch(){ const v=document.getElementById("searchInput").value.trim(); if(v) location.href=`/?province=${encodeURIComponent(v)}`;}

    function showSection(sectionKey){
      const map = {
        'weather': ['nowcast-card-modern'],
        'hourly': ['hourly-card'],
        'forecast': ['daily-forecast'],
        'trends': ['overview-row'],
        'climate': ['climate-info','climate-summary'],
        'map': ['map-card']
      };
      document.querySelectorAll('.card').forEach(sec=>sec.style.display='none');
      (map[sectionKey]||[]).forEach(cls=>{
        const el=document.querySelector('.'+cls);
        if(el) el.style.display='block';
      });
    }

    window.onload = () => {
      // Init map
      const map = L.map('map').setView([21.0285, 105.8542], 6);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    };
  </script>
</body>
</html>
